---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import AgendaFilters from "../../../components/agenda/AgendaFilters.astro";
import { content } from "../../../data/mock/content";

/**
 * MESES DISPONIBLES
 */
const months = [
  { index: 0, name: "Enero", slug: "enero" },
  { index: 1, name: "Febrero", slug: "febrero" },
  { index: 2, name: "Marzo", slug: "marzo" },
  { index: 3, name: "Abril", slug: "abril" },
  { index: 4, name: "Mayo", slug: "mayo" },
];

const year = 2026;

/**
 * RUTAS ESTÁTICAS
 */
export function getStaticPaths() {
  return [
    { params: { mes: "enero" } },
    { params: { mes: "febrero" } },
    { params: { mes: "marzo" } },
    { params: { mes: "abril" } },
    { params: { mes: "mayo" } },
  ];
}

const { mes } = Astro.params;

// Encontrar mes actual
const currentMonthIndex = months.findIndex((m) => m.slug === mes);
const currentMonth = months[currentMonthIndex] || months[1]; // Febrero por defecto

/**
 * FECHAS
 */
const monthPrefix = `${year}-${String(currentMonth.index + 1).padStart(2, "0")}`;
const today = new Date().toISOString().split("T")[0];

/**
 * EVENTOS Y ACTIVIDADES DEL MES
 */
type EventoNode = Extract<(typeof content)[number], { type: "EVENTO" }>;
type ActividadNode = Extract<(typeof content)[number], { type: "ACTIVIDAD" }>;

const agendaItems = content.filter(
  (item): item is EventoNode | ActividadNode =>
    (item.type === "EVENTO" || item.type === "ACTIVIDAD") &&
    !!item.data.date &&
    item.data.date.startsWith(monthPrefix)
);

/**
 * AGRUPAR ITEMS POR DÍA
 */
const itemsByDay: Record<string, typeof agendaItems> = {};

agendaItems.forEach((item) => {
  const day = item.data.date!.split("-")[2];
  if (!itemsByDay[day]) itemsByDay[day] = [];
  itemsByDay[day].push(item);
});

/**
 * UTILIDADES
 */
const daysInMonth = new Date(year, currentMonth.index + 1, 0).getDate();

const isPast = (date: string) => {
  return new Date(date) < new Date(today);
};

// Navegación meses
const prevMonth = currentMonthIndex > 0 ? months[currentMonthIndex - 1] : null;
const nextMonth = currentMonthIndex < months.length - 1 ? months[currentMonthIndex + 1] : null;
---

<BaseLayout title={`Agenda ${currentMonth.name} ${year} · Santako Music`}>

  <section id="agenda" class="section-agenda px-6 md:px-12 xl:px-24 py-24">
    <div class="max-w-6xl mx-auto">

      <!-- HEADER -->
      <header class="section-header mb-12">
        <h1 class="font-heading text-5xl md:text-6xl mb-4">Agenda</h1>
        <p class="opacity-70 max-w-md">
          Programación cultural y memoria reciente.
        </p>
      </header>

      <!-- NAVEGACIÓN MESES -->
      <nav class="flex flex-wrap items-center gap-3 mb-8">
        {months.map((month, i) => (
          <a 
            href={`/agenda/mes/${month.slug}`}
            class={`px-4 py-2 text-sm uppercase tracking-widest rounded-full transition
              ${i === currentMonthIndex 
                ? "bg-black text-white" 
                : "bg-neutral-100 hover:bg-neutral-200"
              }`}
          >
            {month.name}
          </a>
        ))}
      </nav>

      <!-- MES ACTUAL -->
      <div class="flex items-center justify-between mb-6">
        <h2 class="font-heading text-3xl">
          {currentMonth.name} {year}
        </h2>
        
        <div class="flex gap-4">
          {prevMonth && (
            <a href={`/agenda/mes/${prevMonth.slug}`} class="text-sm uppercase tracking-widest hover:opacity-70 transition">
              ← {prevMonth.name}
            </a>
          )}
          {nextMonth && (
            <a href={`/agenda/mes/${nextMonth.slug}`} class="text-sm uppercase tracking-widest hover:opacity-70 transition">
              {nextMonth.name} →
            </a>
          )}
        </div>
      </div>

      <!-- FILTROS -->
      <div class="mb-8">
        <AgendaFilters />
      </div>

      <!-- CALENDARIO -->
      <div class="grid grid-cols-7 gap-2 md:gap-4 mb-16">
        <!-- Días de la semana -->
        {["L", "M", "X", "J", "V", "S", "D"].map((d) => (
          <div class="text-center text-xs uppercase tracking-widest opacity-50 pb-2">
            {d}
          </div>
        ))}

        <!-- Offset para el primer día del mes -->
        {Array.from({ length: (new Date(year, currentMonth.index, 1).getDay() + 6) % 7 }, () => (
          <div class="min-h-[100px] md:min-h-[140px]"></div>
        ))}

        <!-- Días del mes -->
        {Array.from({ length: daysInMonth }, (_, i) => {
          const dayNumber = i + 1;
          const day = String(dayNumber).padStart(2, "0");
          const fullDate = `${monthPrefix}-${day}`;
          const isToday = fullDate === today;
          const past = isPast(fullDate);
          const dayEvents = itemsByDay[day] || [];
          const hasEvents = dayEvents.length > 0;

          return (
            <div
              class={`relative min-h-[100px] md:min-h-[140px] p-2 md:p-3 flex flex-col gap-2 border rounded-lg transition
                ${isToday
                  ? "border-[--color-accent-live] bg-[--color-accent-live]/10"
                  : past
                  ? "border-black/5 bg-neutral-50"
                  : hasEvents
                  ? "border-[--color-accent-event]/50 bg-white hover:border-[--color-accent-event]"
                  : "border-black/10 bg-white"
                }`}
            >
              {/* Número del día */}
              <span class={`font-mono text-sm ${past ? "opacity-30" : "opacity-60"}`}>
                {day}
              </span>

              {/* Eventos del día */}
              {hasEvents && (
                <div class="flex flex-col gap-1 flex-1">
                  {dayEvents.slice(0, 2).map((item) => (
                    <a
                      href={item.type === "EVENTO" ? `/evento/${item.data.slug}` : `/actividad/${item.data.slug}`}
                      class="text-xs leading-tight truncate hover:opacity-70 transition"
                      title={item.data.title}
                    >
                      {item.data.title}
                    </a>
                  ))}
                  {dayEvents.length > 2 && (
                    <span class="text-xs opacity-50">+{dayEvents.length - 2} más</span>
                  )}
                </div>
              )}
            </div>
          );
        })}
      </div>

      <!-- CTA -->
      <div class="p-8 md:p-10 border border-black/10 bg-neutral-50 rounded-lg">
        <span class="text-xs uppercase tracking-widest opacity-50 mb-2 block">Colaboraciones</span>
        <h2 class="font-heading text-2xl md:text-3xl mb-4">
          Programación cultural con identidad
        </h2>
        <p class="max-w-lg mb-6 opacity-80">
          Colaboramos con salas, centros culturales y entidades públicas para crear 
          propuestas musicales con sentido. Si tienes un espacio o proyecto, hablemos.
        </p>
        <a
          href="mailto:hola@santakomusic.com?subject=Propuesta de colaboración"
          class="inline-block text-sm uppercase tracking-widest border-b border-black pb-1 hover:opacity-70 transition"
        >
          Proponer colaboración
        </a>
      </div>

    </div>
  </section>

</BaseLayout>
