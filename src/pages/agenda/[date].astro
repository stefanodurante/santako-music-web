---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { content } from "../../data/mock/content";

/**
 * STATIC PATHS
 * Generamos solo días que tengan eventos
 */
export function getStaticPaths() {
  const dates = content
    .filter((item) => item.type === "EVENTO" && item.data.date)
    .map((item) => item.data.date);

  const uniqueDates = Array.from(new Set(dates));

  return uniqueDates.map((date) => ({
    params: { date },
  }));
}

/**
 * PARAM
 */
const { date } = Astro.params;

/**
 * EVENTOS DEL DÍA
 */
const events = content.filter(
  (item) => item.type === "EVENTO" && item.data.date === date,
);

if (events.length === 0) {
  throw new Error("No hay eventos para este día");
}

/**
 * UTILIDADES
 */
const day = new Date(date);
const formattedDate = day.toLocaleDateString("es-ES", {
  weekday: "long",
  day: "numeric",
  month: "long",
  year: "numeric",
});
---

<BaseLayout title={`Agenda · ${formattedDate}`}>
  <section id="agenda-dia" class="section-agenda px-6 md:px-12 xl:px-24 py-24 container-wide">
    <!-- HEADER DÍA -->
    <header class="section-header mb-16">
      <span class="text-xs uppercase tracking-widest opacity-60">
        Agenda · Día
      </span>

      <h1 class="font-heading text-4xl md:text-5xl mt-3 capitalize">
        {formattedDate}
      </h1>
    </header>

    <!-- EVENTOS DEL DÍA -->
    <section class="section-events space-y-12">
      {
        events.map((event) => (
          <article class="border-t border-black/10 pt-8">
            <span class="text-xs uppercase tracking-widest opacity-60">
              {event.data.label}
            </span>

            <h2 class="font-heading text-3xl mt-2 mb-4">{event.data.title}</h2>

            <a
              href={`/evento/${event.data.slug}`}
              class="inline-block text-sm uppercase tracking-widest border-b border-black pb-1 hover:opacity-70 transition"
            >
              Ver evento
            </a>

            {/* PERSONAS RELACIONADAS */}
            {event.data.related && (
              <div class="mt-6">
                <p class="text-xs uppercase tracking-widest opacity-60 mb-2">
                  Participan
                </p>
                <ul class="flex flex-wrap gap-3">
                  {event.data.related.map((slug) => {
                    const person = content.find(
                      (item) =>
                        item.type === "PERSONA" && item.data.slug === slug,
                    );

                    return (
                      person && (
                        <li>
                          <a
                            href={`/persona/${person.data.slug}`}
                            class="underline"
                          >
                            {person.data.title}
                          </a>
                        </li>
                      )
                    );
                  })}
                </ul>
              </div>
            )}
          </article>
        ))
      }
    </section>

    <!-- CTA -->
    <div id="agenda-cta" class="section-cta mt-20 p-8 bg-neutral-50 border border-black/10">
      <h3 class="font-heading text-2xl mb-4">¿Te apuntas?</h3>
      <p class="max-w-md mb-6 opacity-80">
        Consulta los detalles de cada evento o escríbenos si quieres colaborar.
      </p>
      <a
        href="mailto:hola@santakomusic.com"
        class="inline-block text-sm uppercase tracking-widest border-b border-black pb-1 hover:opacity-70 transition"
      >
        Contactar
      </a>
    </div>
  </section>
</BaseLayout>
